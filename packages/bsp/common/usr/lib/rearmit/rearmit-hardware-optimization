#!/bin/bash
#
# Copyright (c) Authors: https://www.armbian.com/authors
#
# This file is licensed under the terms of the GNU General Public
# License version 2. This program is licensed "as is" without any
# warranty of any kind, whether express or implied.

# Functions:
#
# limit_resolution_to_fullhd

limit_resolution_to_fullhd() {

	# check for /boot/orangepiEnv.txt existence
	[ -f /boot/armbianEnv.txt ] || return

	# cleanup. add LF. This prevents adding parameters to the same line
	echo "" >> /boot/armbianEnv.txt;  sed -i '/^$/d;$G' /boot/armbianEnv.txt; sed -i '/^$/d;$G' /boot/armbianEnv.txt

	# cleanup. remove empty lines in the middle
	sed -i '/^$/d' /boot/armbianEnv.txt

	# preserve old contents if existent
	TMPFILE=$(mktemp /tmp/${0##*/}.XXXXXX)
	trap "sleep 1 ; rm \"${TMPFILE}\" ; exit 0" 0 1 2 3 15
	awk -F"=" '/^extraargs/ {print $2}' </boot/armbianEnv.txt | tr -d -c '[:graph:]' >${TMPFILE}

	resolution=$(cat /sys/class/graphics/fb0/virtual_size)
	width=${resolution%%,*}
	if [ "${width}" -gt 1920 ]; then
		echo "extraargs=video=HDMI-A-1:1920x1080@60e" >> /boot/armbianEnv.txt
		sed -i 's/# video_fullscreen_x = 0/video_fullscreen_x = 1920/' /opt/retropie/configs/all/retroarch.cfg
		sed -i 's/# video_fullscreen_y = 0/video_fullscreen_y = 1080/' /opt/retropie/configs/all/retroarch.cfg
		sed -i 's/# video_fullscreen = false/video_fullscreen = true/' /opt/retropie/configs/all/retroarch.cfg
		reboot
	fi

} # limit_resolution_to_fullhd

set_hdmi_audio() {
	local hw="0"
	
	if [ -z "`aplay -l | grep hdmi | grep 'card 0'`"  ]; then
		hw="0"
	fi

	if [ -z "`aplay -l | grep hdmi | grep 'card 0'`"  ]; then
		hw="1"
	fi

	# create asound.conf
	cat > /etc/asound.conf << _EOF_
pcm.!default {
  type plug
  slave.pcm "dmixer"
}

pcm.dmixer  {
  type dmix
  ipc_key 1024
  slave {
    pcm "hw:$hw,0"
    period_time 0
    period_size 1024
    buffer_size 4096
    rate 44100
  }
  bindings {
    0 0
    1 1
  }
}

ctl.dmixer {
  type hw
  card 0
}

ctl.!default {
    type hw
    card 0
}
_EOF_

} # set_hdmi_audio

case $1 in
	*start*)
		# limit resolution to fullhd
		set_hdmi_audio &
		limit_resolution_to_fullhd &
		;;
esac
